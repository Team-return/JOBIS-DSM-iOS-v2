default_platform(:ios)

# Get project root directory
PROJECT_ROOT = File.expand_path("..", __dir__)
WORKSPACE_PATH = File.join(PROJECT_ROOT, "JOBIS-DSM-iOS-v2.xcworkspace")
TEST_OUTPUT_PATH = File.join(PROJECT_ROOT, "test_output")
XCODEPROJ_PATH = File.join(PROJECT_ROOT, "Projects/App/JOBIS-DSM-iOS-v2.xcodeproj")

platform :ios do

  desc "Run tests"
  lane :test do
    run_tests(
      workspace: WORKSPACE_PATH,
      scheme: "JOBIS-DSM-iOS-v2-DEV",
      devices: ["iPhone 15 Pro"],
      code_coverage: true,
      result_bundle: true,
      output_directory: TEST_OUTPUT_PATH,
      clean: true
    )
  end

  desc "Build for development"
  lane :build_dev do
    xcodebuild(
      workspace: WORKSPACE_PATH,
      scheme: "JOBIS-DSM-iOS-v2-DEV",
      configuration: "DEV",
      clean: true,
      build: true,
      destination: "platform=iOS Simulator,name=iPhone 15 Pro",
      xcargs: "-skipPackagePluginValidation"
    )
  end

  desc "Build for staging"
  lane :build_stage do
    xcodebuild(
      workspace: WORKSPACE_PATH,
      scheme: "JOBIS-DSM-iOS-v2-STAGE",
      configuration: "STAGE",
      clean: true,
      build: true,
      destination: "platform=iOS Simulator,name=iPhone 15 Pro",
      xcargs: "-skipPackagePluginValidation"
    )
  end

  desc "Build for production"
  lane :build_prod do
    build_app(
      workspace: WORKSPACE_PATH,
      scheme: "JOBIS-DSM-iOS-v2-PROD",
      configuration: "PROD",
      export_method: "app-store",
      clean: true
    )
  end

  desc "Run SwiftLint"
  lane :lint do
    swiftlint(
      mode: :lint,
      executable: "Pods/SwiftLint/swiftlint",
      config_file: ".swiftlint.yml",
      raise_if_swiftlint_error: true
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    increment_build_number(xcodeproj: XCODEPROJ_PATH)
    build_prod
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "CI Build and Test"
  lane :ci do
    build_dev
    test
  end
end
