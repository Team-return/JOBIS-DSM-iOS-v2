default_platform(:ios)

# Get project root directory
PROJECT_ROOT = File.expand_path("..", __dir__)

platform :ios do

  desc "Build for development"
  lane :build_dev do
    Dir.chdir(PROJECT_ROOT) do
      sh("mise", "exec", "--", "tuist", "build", "JOBIS-DSM-iOS-v2-DEV")
    end
  end

  desc "Build for staging"
  lane :build_stage do
    Dir.chdir(PROJECT_ROOT) do
      sh("mise", "exec", "--", "tuist", "build", "JOBIS-DSM-iOS-v2-STAGE")
    end
  end

  desc "Build for production"
  lane :build_prod do
    Dir.chdir(PROJECT_ROOT) do
      sh("mise", "exec", "--", "tuist", "build", "JOBIS-DSM-iOS-v2-PROD")
    end
  end

  desc "CI Build"
  lane :ci do
    build_dev
  end

  desc "Build and upload to TestFlight (DEV - Testing only)"
  lane :beta do
    # Generate project first
    Dir.chdir(PROJECT_ROOT) do
      sh("mise", "exec", "--", "tuist", "fetch")
      sh("mise", "exec", "--", "tuist", "generate", "--xcframeworks")
    end

    # Build the app (Xcode will use existing signing from project)
    build_app(
      workspace: "#{PROJECT_ROOT}/JOBIS-DSM-iOS-v2.xcworkspace",
      scheme: "JOBIS-DSM-iOS-v2-DEV",
      export_method: "app-store",
      output_directory: "#{PROJECT_ROOT}/build",
      output_name: "JOBIS-DSM-iOS-v2-DEV.ipa"
    )

    # Upload to TestFlight (DEV 앱)
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      app_identifier: "com.team.return.JOBIS-DSM-iOS.dev"
    )
  end

  desc "Build and upload to App Store (Production - App ID: 6450888392)"
  lane :release do
    # Generate project first
    Dir.chdir(PROJECT_ROOT) do
      sh("mise", "exec", "--", "tuist", "fetch")
      sh("mise", "exec", "--", "tuist", "generate", "--xcframeworks")
    end

    # Build the app (Xcode will use existing signing from project)
    build_app(
      workspace: "#{PROJECT_ROOT}/JOBIS-DSM-iOS-v2.xcworkspace",
      scheme: "JOBIS-DSM-iOS-v2-PROD",
      export_method: "app-store",
      output_directory: "#{PROJECT_ROOT}/build",
      output_name: "JOBIS-DSM-iOS-v2-PROD.ipa"
    )

    # Upload to TestFlight first (PROD 앱 - App ID: 6450888392)
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      app_identifier: "com.team.return.JOBIS-DSM-iOS"
    )
  end

  desc "Submit PROD app to App Store for review"
  lane :submit_review do
    # Submit latest build for App Store review
    upload_to_app_store(
      skip_binary_upload: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: true,
      automatic_release: false,
      app_identifier: "com.team.return.JOBIS-DSM-iOS"
    )
  end
end
